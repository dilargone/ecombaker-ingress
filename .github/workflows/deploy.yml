name: Deploy Ingress

on:
  push:
    branches:
      - main
    paths:
      - 'base/**'
      - 'overlays/**'
      - '.github/workflows/deploy.yml'
  
  pull_request:
    branches:
      - main
    paths:
      - 'base/**'
      - 'overlays/**'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
        default: 'dev'
      namespace:
        description: 'Kubernetes namespace (will be created if not exists)'
        required: false
        type: string
        default: 'default'

jobs:
  validate:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
      
      - name: Validate base manifests (syntax only)
        run: |
          echo "Building base manifests..."
          kustomize build base/ > /tmp/base-manifest.yaml
          echo "✅ Base manifests build successfully"
      
      - name: Validate dev overlay (syntax only)
        run: |
          echo "Building dev overlay..."
          kustomize build overlays/dev/ > /tmp/dev-manifest.yaml
          echo "✅ Dev overlay builds successfully"
      
      - name: Validate qa overlay (syntax only)
        run: |
          echo "Building qa overlay..."
          kustomize build overlays/qa/ > /tmp/qa-manifest.yaml
          echo "✅ QA overlay builds successfully"
      
      - name: Validate prod overlay (syntax only)
        run: |
          echo "Building prod overlay..."
          kustomize build overlays/prod/ > /tmp/prod-manifest.yaml
          echo "✅ Prod overlay builds successfully"
      
      - name: Run kubeval (YAML validation)
        run: |
          echo "Installing kubeval..."
          wget -q https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          echo ""
          echo "Validating base manifests..."
          kustomize build base/ | kubeval --strict --ignore-missing-schemas
          echo ""
          echo "Validating dev overlay..."
          kustomize build overlays/dev/ | kubeval --strict --ignore-missing-schemas
          echo ""
          echo "Validating qa overlay..."
          kustomize build overlays/qa/ | kubeval --strict --ignore-missing-schemas
          echo ""
          echo "Validating prod overlay..."
          kustomize build overlays/prod/ | kubeval --strict --ignore-missing-schemas
          echo ""
          echo "✅ All manifests are valid!"

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: development
      url: https://dev.ecombaker.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          echo "Kubeconfig configured successfully"
          
      - name: Verify cluster connection
        run: |
          echo "Testing connection to cluster..."
          kubectl cluster-info || (echo "Failed to connect to cluster" && exit 1)
          kubectl get nodes || true
      
      - name: Setup namespace
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Target namespace: $NAMESPACE"
          
          if kubectl get namespace "$NAMESPACE" &> /dev/null; then
            echo "✅ Namespace '$NAMESPACE' already exists"
          else
            echo "Creating namespace '$NAMESPACE'..."
            kubectl create namespace "$NAMESPACE"
            echo "✅ Namespace '$NAMESPACE' created successfully"
          fi
          
          echo ""
          echo "Current namespaces:"
          kubectl get namespaces
      
      - name: Deploy to dev
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Deploying to namespace: $NAMESPACE"
          
          # Build the manifest and apply with namespace override
          kubectl kustomize overlays/dev/ | kubectl apply -n "$NAMESPACE" -f -
          
          echo "✅ Ingress deployed successfully to namespace: $NAMESPACE"
      
      - name: Wait for ingress (optional)
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Waiting for ingress to be ready (this may timeout, but that's OK)..."
          kubectl wait --for=condition=Ready --timeout=60s ingress/ecombaker-ingress -n "$NAMESPACE" || echo "⚠️  Timeout reached, but ingress is still functional"
      
      - name: Get ingress status
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Current ingress status in namespace: $NAMESPACE"
          kubectl get ingress ecombaker-ingress -n "$NAMESPACE" -o wide
          echo ""
          echo "Ingress details:"
          kubectl describe ingress ecombaker-ingress -n "$NAMESPACE" | grep -A 10 "Rules\|Events" || true
      
      - name: Verify deployment
        run: |
          chmod +x scripts/verify.sh
          ./scripts/verify.sh dev || true

  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.environment == 'qa' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment:
      name: qa
      url: https://qa.ecombaker.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_QA }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          echo "Kubeconfig configured successfully"
          
      - name: Verify cluster connection
        run: |
          echo "Testing connection to cluster..."
          kubectl cluster-info || (echo "Failed to connect to cluster" && exit 1)
          kubectl get nodes || true
      
      - name: Setup namespace
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Target namespace: $NAMESPACE"
          
          if kubectl get namespace "$NAMESPACE" &> /dev/null; then
            echo "✅ Namespace '$NAMESPACE' already exists"
          else
            echo "Creating namespace '$NAMESPACE'..."
            kubectl create namespace "$NAMESPACE"
            echo "✅ Namespace '$NAMESPACE' created successfully"
          fi
          
          echo ""
          echo "Current namespaces:"
          kubectl get namespaces
      
      - name: Deploy to QA
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Deploying to namespace: $NAMESPACE"
          
          # Build the manifest and apply with namespace override
          kubectl kustomize overlays/qa/ | kubectl apply -n "$NAMESPACE" -f -
          
          echo "✅ Ingress deployed successfully to namespace: $NAMESPACE"
      
      - name: Wait for ingress (optional)
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Waiting for ingress to be ready (this may timeout, but that's OK)..."
          kubectl wait --for=condition=Ready --timeout=60s ingress/ecombaker-ingress -n "$NAMESPACE" || echo "⚠️  Timeout reached, but ingress is still functional"
      
      - name: Get ingress status
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Current ingress status in namespace: $NAMESPACE"
          kubectl get ingress ecombaker-ingress -n "$NAMESPACE" -o wide
          echo ""
          echo "Ingress details:"
          kubectl describe ingress ecombaker-ingress -n "$NAMESPACE" | grep -A 10 "Rules\|Events" || true
      
      - name: Verify deployment
        run: |
          chmod +x scripts/verify.sh
          ./scripts/verify.sh qa || true
      
      - name: Notify QA team
        if: success()
        run: |
          echo "QA deployment successful!"
          # Add Slack/email notification here

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, deploy-qa]
    if: github.event.inputs.environment == 'prod'
    environment:
      name: production
      url: https://ecombaker.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          echo "Kubeconfig configured successfully"
          
      - name: Verify cluster connection
        run: |
          echo "Testing connection to cluster..."
          kubectl cluster-info || (echo "Failed to connect to cluster" && exit 1)
          kubectl get nodes || true
      
      - name: Setup namespace
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Target namespace: $NAMESPACE"
          
          if kubectl get namespace "$NAMESPACE" &> /dev/null; then
            echo "✅ Namespace '$NAMESPACE' already exists"
          else
            echo "Creating namespace '$NAMESPACE'..."
            kubectl create namespace "$NAMESPACE"
            echo "✅ Namespace '$NAMESPACE' created successfully"
          fi
          
          echo ""
          echo "Current namespaces:"
          kubectl get namespaces
      
      - name: Deploy to Production
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          echo "Deploying to namespace: $NAMESPACE"
          
          # Build the manifest and apply with namespace override
          kubectl kustomize overlays/prod/ | kubectl apply -n "$NAMESPACE" -f -
          
          echo "✅ Ingress deployed successfully to namespace: $NAMESPACE"
      
      - name: Wait for ingress
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          kubectl wait --for=condition=Ready --timeout=300s ingress/ecombaker-ingress -n "$NAMESPACE" || echo "⚠️  Timeout reached, but ingress may still be functional"
      
      - name: Get ingress status
        run: |
          NAMESPACE="${{ github.event.inputs.namespace || 'default' }}"
          kubectl get ingress ecombaker-ingress -n "$NAMESPACE" -o wide
      
      - name: Verify deployment
        run: |
          chmod +x scripts/verify.sh
          ./scripts/verify.sh prod
      
      - name: Check certificate status
        run: |
          kubectl get certificate
          kubectl describe certificate ecombaker-tls-secret
      
      - name: Smoke test
        run: |
          EXTERNAL_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "Testing health endpoint..."
          curl -f -H "Host: store1.ecombaker.com" https://$EXTERNAL_IP/actuator/health || exit 1
      
      - name: Notify team
        if: success()
        run: |
          echo "Production deployment successful!"
          # Add Slack/email notification here
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          kubectl rollout undo ingress ecombaker-ingress
