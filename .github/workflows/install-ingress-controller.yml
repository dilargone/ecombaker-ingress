name: Install NGINX Ingress Controller

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to install ingress controller'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
        default: 'dev'
      install_controller:
        description: 'Install NGINX Ingress Controller (creates LoadBalancer)'
        required: true
        type: boolean
        default: true
      namespace:
        description: 'Namespace for ingress controller'
        required: false
        type: string
        default: 'ingress-nginx'
      loadbalancer_ip:
        description: 'LoadBalancer IP (optional - leave empty for auto-assign, or specify existing IP like 138.197.254.45)'
        required: false
        type: string

jobs:
  install-ingress-controller:
    name: Install NGINX Ingress Controller
    runs-on: ubuntu-latest
    if: github.event.inputs.install_controller == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          if [ "${{ github.event.inputs.environment }}" == "dev" ]; then
            echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > ~/.kube/config
          elif [ "${{ github.event.inputs.environment }}" == "qa" ]; then
            echo "${{ secrets.KUBE_CONFIG_QA }}" | base64 -d > ~/.kube/config
          elif [ "${{ github.event.inputs.environment }}" == "prod" ]; then
            echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          fi
          chmod 600 ~/.kube/config
          echo "Kubeconfig configured for ${{ github.event.inputs.environment }}"
      
      - name: Verify cluster connection
        run: |
          echo "Testing connection to cluster..."
          kubectl cluster-info
          kubectl get nodes
      
      - name: Check if ingress controller already exists
        id: check
        run: |
          if kubectl get namespace ingress-nginx &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  NGINX Ingress Controller already installed"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… Ready to install NGINX Ingress Controller"
          fi
      
      - name: Install NGINX Ingress Controller
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Installing NGINX Ingress Controller for DigitalOcean..."
          
          # Download the manifest
          curl -sL https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.5/deploy/static/provider/do/deploy.yaml -o /tmp/ingress-nginx.yaml
          
          # If LoadBalancer IP is specified, patch the service
          if [ -n "${{ github.event.inputs.loadbalancer_ip }}" ]; then
            echo "ðŸ“Œ Configuring LoadBalancer to use IP: ${{ github.event.inputs.loadbalancer_ip }}"
            
            # Add loadBalancerIP to the service spec
            cat /tmp/ingress-nginx.yaml | \
              sed '/^  type: LoadBalancer$/a\  loadBalancerIP: ${{ github.event.inputs.loadbalancer_ip }}' > /tmp/ingress-nginx-patched.yaml
            
            kubectl apply -f /tmp/ingress-nginx-patched.yaml
          else
            echo "ðŸ”„ Auto-assigning new LoadBalancer IP..."
            kubectl apply -f /tmp/ingress-nginx.yaml
          fi
          
          echo "âœ… Installation started"
      
      - name: Wait for controller to be ready
        if: steps.check.outputs.exists == 'false'
        run: |
          echo "Waiting for ingress controller pods to be ready..."
          kubectl wait --namespace ingress-nginx \
            --for=condition=ready pod \
            --selector=app.kubernetes.io/component=controller \
            --timeout=120s || echo "âš ï¸  Timeout waiting for pods, but may still be starting"
      
      - name: Wait for LoadBalancer IP
        run: |
          echo "Waiting for LoadBalancer external IP to be assigned..."
          for i in {1..60}; do
            EXTERNAL_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
            if [ -n "$EXTERNAL_IP" ] && [ "$EXTERNAL_IP" != "null" ]; then
              echo "âœ… LoadBalancer IP assigned: $EXTERNAL_IP"
              echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_ENV
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          
          if [ -z "$EXTERNAL_IP" ] || [ "$EXTERNAL_IP" == "null" ]; then
            echo "âš ï¸  LoadBalancer IP not assigned yet. Check DigitalOcean console."
          fi
      
      - name: Get ingress controller status
        run: |
          echo "=== NGINX Ingress Controller Status ==="
          echo ""
          echo "Pods:"
          kubectl get pods -n ingress-nginx
          echo ""
          echo "Services:"
          kubectl get svc -n ingress-nginx
          echo ""
          echo "IngressClass:"
          kubectl get ingressclass
      
      - name: Display LoadBalancer information
        run: |
          EXTERNAL_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          ENV="${{ github.event.inputs.environment }}"
          REQUESTED_IP="${{ github.event.inputs.loadbalancer_ip }}"
          
          echo "=============================================="
          echo "âœ… NGINX Ingress Controller Installed!"
          echo "=============================================="
          echo ""
          echo "Environment: $ENV"
          echo "Namespace: ingress-nginx"
          echo ""
          
          if [ -n "$REQUESTED_IP" ]; then
            echo "ðŸ“Œ Requested LoadBalancer IP: $REQUESTED_IP"
          fi
          
          if [ -n "$EXTERNAL_IP" ] && [ "$EXTERNAL_IP" != "null" ]; then
            echo "ðŸŒ LoadBalancer External IP: $EXTERNAL_IP"
            
            # Check if the IP matches what was requested
            if [ -n "$REQUESTED_IP" ] && [ "$EXTERNAL_IP" == "$REQUESTED_IP" ]; then
              echo "âœ… Successfully bound to requested IP!"
            elif [ -n "$REQUESTED_IP" ] && [ "$EXTERNAL_IP" != "$REQUESTED_IP" ]; then
              echo "âš ï¸  Warning: Assigned IP doesn't match requested IP. This may indicate the requested IP was unavailable."
            fi
            
            echo ""
            echo "ðŸ“‹ Next Steps:"
            echo "1. Update DNS records:"
            
            # Show environment-specific DNS
            if [ "$ENV" == "prod" ]; then
              echo "   *.ecombaker.com         A    $EXTERNAL_IP"
              echo "   ecombaker.com           A    $EXTERNAL_IP"
            elif [ "$ENV" == "qa" ]; then
              echo "   *.qa.ecombaker.com      A    $EXTERNAL_IP"
              echo "   qa.ecombaker.com        A    $EXTERNAL_IP"
            else
              echo "   *.dev.ecombaker.com     A    $EXTERNAL_IP"
              echo "   dev.ecombaker.com       A    $EXTERNAL_IP"
            fi
            
            echo ""
            echo "2. Deploy your ingress resources:"
            echo "   kubectl apply -k overlays/$ENV/"
            echo ""
            echo "3. Change application services from LoadBalancer to ClusterIP"
            echo ""
            
            if [ -n "$REQUESTED_IP" ]; then
              echo "ï¿½ Reusing existing LoadBalancer IP - no additional cost!"
            else
              echo "ï¿½ðŸ’° Cost: ~\$12/month for this LoadBalancer"
            fi
          else
            echo "âš ï¸  LoadBalancer IP pending - check DigitalOcean console"
          fi
          echo "=============================================="
      
      - name: Cost warning
        if: steps.check.outputs.exists == 'false'
        run: |
          REQUESTED_IP="${{ github.event.inputs.loadbalancer_ip }}"
          
          if [ -n "$REQUESTED_IP" ]; then
            echo "ðŸ’¡ Reusing existing LoadBalancer IP: $REQUESTED_IP"
            echo "Make sure to delete the old service using this IP to avoid conflicts"
          else
            echo "âš ï¸  IMPORTANT: This creates a new DigitalOcean LoadBalancer (~\$12/month)"
          fi
          
          echo "To remove ingress controller: kubectl delete namespace ingress-nginx"

  uninstall-ingress-controller:
    name: Uninstall NGINX Ingress Controller
    runs-on: ubuntu-latest
    if: github.event.inputs.install_controller == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          if [ "${{ github.event.inputs.environment }}" == "dev" ]; then
            echo "${{ secrets.KUBE_CONFIG_DEV }}" | base64 -d > ~/.kube/config
          elif [ "${{ github.event.inputs.environment }}" == "qa" ]; then
            echo "${{ secrets.KUBE_CONFIG_QA }}" | base64 -d > ~/.kube/config
          elif [ "${{ github.event.inputs.environment }}" == "prod" ]; then
            echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > ~/.kube/config
          fi
          chmod 600 ~/.kube/config
      
      - name: Verify cluster connection
        run: |
          kubectl cluster-info
      
      - name: Backup ingress resources
        run: |
          echo "Backing up all ingress resources..."
          kubectl get ingress -A -o yaml > ingress-backup-$(date +%Y%m%d-%H%M%S).yaml 2>/dev/null || echo "No ingress resources found"
      
      - name: Get LoadBalancer IP before deletion
        run: |
          EXTERNAL_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "N/A")
          echo "LoadBalancer IP being released: $EXTERNAL_IP"
      
      - name: Uninstall NGINX Ingress Controller
        run: |
          echo "âš ï¸  Deleting NGINX Ingress Controller and LoadBalancer..."
          if kubectl get namespace ingress-nginx &> /dev/null; then
            kubectl delete namespace ingress-nginx
            echo "âœ… NGINX Ingress Controller deleted"
            echo "ðŸ’° LoadBalancer cost savings: ~\$12/month"
          else
            echo "â„¹ï¸  NGINX Ingress Controller not installed"
          fi
      
      - name: Verify deletion
        run: |
          echo "Checking resources..."
          kubectl get namespace ingress-nginx 2>&1 || echo "âœ… Namespace deleted"
          kubectl get svc -A | grep LoadBalancer || echo "No LoadBalancer services"
